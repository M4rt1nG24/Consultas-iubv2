<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Listado de Asistencia</title>
  <link rel="stylesheet" href="css/formato.css">
  <script defer>
    // Funci√≥n para previsualizar la firma seleccionada (imagen)
    function mostrarImagenFirma(event, tipo) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById(`imagenFirma_${tipo}`);
          img.src = e.target.result;
          img.style.display = "block";
          document.getElementById(`lineaFirma_${tipo}`).style.display = "none";
        };
        reader.readAsDataURL(file);
      }
    }

    // Funci√≥n para abrir el selector de archivo (simula clic oculto)
    function abrirSelectorFirma(tipo) {
      document.getElementById(`inputFirma_${tipo}`).click();
    }
  // ================================
  // GUARDAR REPORTE EN BASE DE DATOS Y PDF
  // ================================
  async function guardarReporte() {
    const nombreReporte = prompt("Ingrese el nombre del reporte:");
    if (!nombreReporte) {
      alert("Debe ingresar un nombre para el reporte.");
      return;
    }

    const idUsuario = localStorage.getItem("id_usuario");
    if (!idUsuario) {
      alert("No se encontr√≥ el ID del usuario. Por favor inicie sesi√≥n.");
      return;
    }

    // üîπ Selecciona la tabla (sin el bot√≥n)
    const tabla = document.querySelector("tabla_estudiantes");
    const boton = tabla.querySelector("button");
    boton.style.display = "none"; // ocultar antes de capturar

    // üîπ Capturar la tabla como imagen con html2canvas
    const canvas = await html2canvas(tabla, { scale: 2 });
    const imgData = canvas.toDataURL("image/png");

    // üîπ Crear PDF con jsPDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "pt", "a4");
    const imgWidth = 550;
    const pageHeight = 780;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, "PNG", 25, position + 20, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, "PNG", 25, position + 20, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    // üîπ Convertir PDF a Base64
    const pdfBase64 = pdf.output("datauristring").split(",")[1];

    boton.style.display = "block"; // mostrar de nuevo

    // üîπ Enviar datos al backend
    const datos = {
      id_usuario: idUsuario,
      nombre_reporte: nombreReporte,
      archivo_pdf: pdfBase64
    };

    try {
      const respuesta = await fetch("https://api-prueba-2-r35v.onrender.com/guardar_reporte", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });

      const resultado = await respuesta.json();
      if (respuesta.ok) {
        alert("‚úÖ Reporte y PDF guardados correctamente.");
      } else {
        alert("‚ùå Error al guardar el reporte: " + resultado.message);
      }
    } catch (error) {
      console.error(error);
      alert("‚ö†Ô∏è Ocurri√≥ un error al conectar con el servidor.");
    }
  }
  </script>
</head>

<body>
<div class="container">

  <table>
    <thead>
      <!-- ENCABEZADO -->
      <tr>
        <th colspan="11">
          <div class="header">
            <div class="logo-docente">
              <img src="Fotos/Logo de la u.png" alt="Logo Universidad" class="logo">
            </div>

            <div class="titulo">
              <h2>CONSULTA ESTUDIANTES</h2>
            </div>

            <div class="columna_vigencia">
              <p><b>FR-GPA-16-V8</b></p>
              <p>Vigencia: 15/12/2022</p>
            </div>
          </div>

          <div class="bloque-docente-programa">
            <div class="bloque-pequeno">
              <label><b>Docente:</b></label>
              <span id="nombre_docente"></span>
            </div>

            <div class="bloque-pequeno">
              <label><b>Programa:</b></label>
              <input type="text" id="programa_academico" placeholder="Programa acad√©mico">
            </div>
          </div>
        </th>
      </tr>

      <!-- ENCABEZADOS DE LISTA -->
      <tr>
        <th>No.</th>
        <th>Nombre completo del estudiante</th>
        <th>Tipo de Documento</th>
        <th>N√∫mero de identificaci√≥n</th>
        <th>Tema de desarrollo</th>
        <th>Programa</th>
        <th>M√≥dulo</th>
        <th>Lugar de consulta</th>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Firma del estudiante</th>
      </tr>
    </thead>

    <tbody id="tabla_estudiantes">
      <!-- Filas din√°micas -->
    </tbody>

    <tfoot>
      <tr>
        <td colspan="11">
          <div class="firmas">
            <div class="columna-izquierda">

              <!-- üîπ Firma Docente -->
              <div class="firma-bloque" onclick="abrirSelectorFirma('docente')">
                <input type="file" id="inputFirma_docente" accept="image/*" style="display:none" onchange="mostrarImagenFirma(event, 'docente')">
                <img id="imagenFirma_docente" style="display:none; max-height:80px;">
                <hr id="lineaFirma_docente">
                <p>Firma del Docente</p>
              </div>

              <!-- üîπ Firma Decano -->
              <div class="firma-bloque" onclick="abrirSelectorFirma('decano')">
                <input type="file" id="inputFirma_decano" accept="image/*" style="display:none" onchange="mostrarImagenFirma(event, 'decano')">
                <img id="imagenFirma_decano" style="display:none; max-height:80px;">
                <hr id="lineaFirma_decano">
                <p>Firma del L√≠der o Decano</p>
              </div>

              <!-- üîπ BOT√ìN GUARDAR REPORTE -->
              <div style="margin-top:20px; text-align:center;">
                <button onclick="guardarReporte()" style="padding:10px 20px; background-color:#004aad; color:white; border:none; border-radius:8px; cursor:pointer;">
                  üíæ Guardar Reporte
                </button>
              </div>

            </div>

            <div class="columna-derecha">
              <h4>Observaciones / Comentarios</h4>
              <textarea placeholder="Escriba aqu√≠ las observaciones..."></textarea>
            </div>
          </div>
        </td>
      </tr>
    </tfoot>
  </table>
</div>

<script src="Javascript/formato.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>



